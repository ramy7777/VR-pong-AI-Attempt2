(()=>{var e={605:(e,t,n)=>{"use strict";n.r(t),n.d(t,{RealtimeAPI:()=>d,RealtimeClient:()=>l,RealtimeConversation:()=>u,RealtimeUtils:()=>o});const s=globalThis.atob,i=globalThis.btoa;class o{static floatTo16BitPCM(e){const t=new ArrayBuffer(2*e.length),n=new DataView(t);let s=0;for(let t=0;t<e.length;t++,s+=2){let i=Math.max(-1,Math.min(1,e[t]));n.setInt16(s,i<0?32768*i:32767*i,!0)}return t}static base64ToArrayBuffer(e){const t=s(e),n=t.length,i=new Uint8Array(n);for(let e=0;e<n;e++)i[e]=t.charCodeAt(e);return i.buffer}static arrayBufferToBase64(e){e instanceof Float32Array?e=this.floatTo16BitPCM(e):e instanceof Int16Array&&(e=e.buffer);let t="",n=new Uint8Array(e);for(let e=0;e<n.length;e+=32768){let s=n.subarray(e,e+32768);t+=String.fromCharCode.apply(null,s)}return i(t)}static mergeInt16Arrays(e,t){if(e instanceof ArrayBuffer&&(e=new Int16Array(e)),t instanceof ArrayBuffer&&(t=new Int16Array(t)),!(e instanceof Int16Array&&t instanceof Int16Array))throw new Error("Both items must be Int16Array");const n=new Int16Array(e.length+t.length);for(let t=0;t<e.length;t++)n[t]=e[t];for(let s=0;s<t.length;s++)n[e.length+s]=t[s];return n}static generateId(e,t=21){return`${e}${Array(t-e.length).fill(0).map((e=>"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"[Math.floor(58*Math.random())])).join("")}`}}const r=e=>new Promise((t=>setTimeout((()=>t()),e)));class a{constructor(){this.eventHandlers={},this.nextEventHandlers={}}clearEventHandlers(){return this.eventHandlers={},this.nextEventHandlers={},!0}on(e,t){return this.eventHandlers[e]=this.eventHandlers[e]||[],this.eventHandlers[e].push(t),t}onNext(e,t){return this.nextEventHandlers[e]=this.nextEventHandlers[e]||[],this.nextEventHandlers[e].push(t),t}off(e,t){const n=this.eventHandlers[e]||[];if(t){const s=n.indexOf(t);if(-1===s)throw new Error(`Could not turn off specified event listener for "${e}": not found as a listener`);n.splice(s,1)}else delete this.eventHandlers[e];return!0}offNext(e,t){const n=this.nextEventHandlers[e]||[];if(t){const s=n.indexOf(t);if(-1===s)throw new Error(`Could not turn off specified next event listener for "${e}": not found as a listener`);n.splice(s,1)}else delete this.nextEventHandlers[e];return!0}async waitForNext(e,t=null){const n=Date.now();let s;for(this.onNext(e,(e=>s=e));!s;){if(t&&Date.now()-n>t)return null;await r(1)}return s}dispatch(e,t){const n=[].concat(this.eventHandlers[e]||[]);for(const e of n)e(t);const s=[].concat(this.nextEventHandlers[e]||[]);for(const e of s)e(t);return delete this.nextEventHandlers[e],!0}}class d extends a{constructor({url:e,apiKey:t,dangerouslyAllowAPIKeyInBrowser:n,debug:s}={}){if(super(),this.defaultUrl="wss://api.openai.com/v1/realtime",this.url=e||this.defaultUrl,this.apiKey=t||null,this.debug=!!s,this.ws=null,globalThis.document&&this.apiKey&&!n)throw new Error('Can not provide API key in the browser without "dangerouslyAllowAPIKeyInBrowser" set to true')}isConnected(){return!!this.ws}log(...e){const t=[`[Websocket/${(new Date).toISOString()}]`].concat(e).map((e=>"object"==typeof e&&null!==e?JSON.stringify(e,null,2):e));return this.debug&&console.log(...t),!0}async connect({model:e}={model:"gpt-4o-realtime-preview-2024-10-01"}){if(this.apiKey||this.url!==this.defaultUrl||console.warn(`No apiKey provided for connection to "${this.url}"`),this.isConnected())throw new Error("Already connected");if(globalThis.WebSocket){globalThis.document&&this.apiKey&&console.warn("Warning: Connecting using API key in the browser, this is not recommended");const t=new(0,globalThis.WebSocket)(`${this.url}${e?`?model=${e}`:""}`,["realtime",`openai-insecure-api-key.${this.apiKey}`,"openai-beta.realtime-v1"]);return t.addEventListener("message",(e=>{const t=JSON.parse(e.data);this.receive(t.type,t)})),new Promise(((e,n)=>{const s=()=>{this.disconnect(t),n(new Error(`Could not connect to "${this.url}"`))};t.addEventListener("error",s),t.addEventListener("open",(()=>{this.log(`Connected to "${this.url}"`),t.removeEventListener("error",s),t.addEventListener("error",(()=>{this.disconnect(t),this.log(`Error, disconnected from "${this.url}"`),this.dispatch("close",{error:!0})})),t.addEventListener("close",(()=>{this.disconnect(t),this.log(`Disconnected from "${this.url}"`),this.dispatch("close",{error:!1})})),this.ws=t,e(!0)}))}))}{const e="ws",t=new(0,(await import(e)).default)("wss://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-10-01",[],{finishRequest:e=>{e.setHeader("Authorization",`Bearer ${this.apiKey}`),e.setHeader("OpenAI-Beta","realtime=v1"),e.end()}});return t.on("message",(e=>{const t=JSON.parse(e.toString());this.receive(t.type,t)})),new Promise(((e,n)=>{const s=()=>{this.disconnect(t),n(new Error(`Could not connect to "${this.url}"`))};t.on("error",s),t.on("open",(()=>{this.log(`Connected to "${this.url}"`),t.removeListener("error",s),t.on("error",(()=>{this.disconnect(t),this.log(`Error, disconnected from "${this.url}"`),this.dispatch("close",{error:!0})})),t.on("close",(()=>{this.disconnect(t),this.log(`Disconnected from "${this.url}"`),this.dispatch("close",{error:!1})})),this.ws=t,e(!0)}))}))}}disconnect(e){if(!e||this.ws===e)return this.ws&&this.ws.close(),this.ws=null,!0}receive(e,t){return this.log("received:",e,t),this.dispatch(`server.${e}`,t),this.dispatch("server.*",t),!0}send(e,t){if(!this.isConnected())throw new Error("RealtimeAPI is not connected");if("object"!=typeof(t=t||{}))throw new Error("data must be an object");const n={event_id:o.generateId("evt_"),type:e,...t};return this.dispatch(`client.${e}`,n),this.dispatch("client.*",n),this.log("sent:",e,n),this.ws.send(JSON.stringify(n)),!0}}class u{defaultFrequency=24e3;EventProcessors={"conversation.item.created":e=>{const{item:t}=e,n=JSON.parse(JSON.stringify(t));if(this.itemLookup[n.id]||(this.itemLookup[n.id]=n,this.items.push(n)),n.formatted={},n.formatted.audio=new Int16Array(0),n.formatted.text="",n.formatted.transcript="",this.queuedSpeechItems[n.id]&&(n.formatted.audio=this.queuedSpeechItems[n.id].audio,delete this.queuedSpeechItems[n.id]),n.content){const e=n.content.filter((e=>["text","input_text"].includes(e.type)));for(const t of e)n.formatted.text+=t.text}return this.queuedTranscriptItems[n.id]&&(n.formatted.transcript=this.queuedTranscriptItems.transcript,delete this.queuedTranscriptItems[n.id]),"message"===n.type?"user"===n.role?(n.status="completed",this.queuedInputAudio&&(n.formatted.audio=this.queuedInputAudio,this.queuedInputAudio=null)):n.status="in_progress":"function_call"===n.type?(n.formatted.tool={type:"function",name:n.name,call_id:n.call_id,arguments:""},n.status="in_progress"):"function_call_output"===n.type&&(n.status="completed",n.formatted.output=n.output),{item:n,delta:null}},"conversation.item.truncated":e=>{const{item_id:t,audio_end_ms:n}=e,s=this.itemLookup[t];if(!s)throw new Error(`item.truncated: Item "${t}" not found`);const i=Math.floor(n*this.defaultFrequency/1e3);return s.formatted.transcript="",s.formatted.audio=s.formatted.audio.slice(0,i),{item:s,delta:null}},"conversation.item.deleted":e=>{const{item_id:t}=e,n=this.itemLookup[t];if(!n)throw new Error(`item.deleted: Item "${t}" not found`);delete this.itemLookup[n.id];const s=this.items.indexOf(n);return s>-1&&this.items.splice(s,1),{item:n,delta:null}},"conversation.item.input_audio_transcription.completed":e=>{const{item_id:t,content_index:n,transcript:s}=e,i=this.itemLookup[t],o=s||" ";return i?(i.content[n].transcript=s,i.formatted.transcript=o,{item:i,delta:{transcript:s}}):(this.queuedTranscriptItems[t]={transcript:o},{item:null,delta:null})},"input_audio_buffer.speech_started":e=>{const{item_id:t,audio_start_ms:n}=e;return this.queuedSpeechItems[t]={audio_start_ms:n},{item:null,delta:null}},"input_audio_buffer.speech_stopped":(e,t)=>{const{item_id:n,audio_end_ms:s}=e;this.queuedSpeechItems[n]||(this.queuedSpeechItems[n]={audio_start_ms:s});const i=this.queuedSpeechItems[n];if(i.audio_end_ms=s,t){const e=Math.floor(i.audio_start_ms*this.defaultFrequency/1e3),n=Math.floor(i.audio_end_ms*this.defaultFrequency/1e3);i.audio=t.slice(e,n)}return{item:null,delta:null}},"response.created":e=>{const{response:t}=e;return this.responseLookup[t.id]||(this.responseLookup[t.id]=t,this.responses.push(t)),{item:null,delta:null}},"response.output_item.added":e=>{const{response_id:t,item:n}=e,s=this.responseLookup[t];if(!s)throw new Error(`response.output_item.added: Response "${t}" not found`);return s.output.push(n.id),{item:null,delta:null}},"response.output_item.done":e=>{const{item:t}=e;if(!t)throw new Error('response.output_item.done: Missing "item"');const n=this.itemLookup[t.id];if(!n)throw new Error(`response.output_item.done: Item "${t.id}" not found`);return n.status=t.status,{item:n,delta:null}},"response.content_part.added":e=>{const{item_id:t,part:n}=e,s=this.itemLookup[t];if(!s)throw new Error(`response.content_part.added: Item "${t}" not found`);return s.content.push(n),{item:s,delta:null}},"response.audio_transcript.delta":e=>{const{item_id:t,content_index:n,delta:s}=e,i=this.itemLookup[t];if(!i)throw new Error(`response.audio_transcript.delta: Item "${t}" not found`);return i.content[n].transcript+=s,i.formatted.transcript+=s,{item:i,delta:{transcript:s}}},"response.audio.delta":e=>{const{item_id:t,content_index:n,delta:s}=e,i=this.itemLookup[t];if(!i)throw new Error(`response.audio.delta: Item "${t}" not found`);const r=o.base64ToArrayBuffer(s),a=new Int16Array(r);return i.formatted.audio=o.mergeInt16Arrays(i.formatted.audio,a),{item:i,delta:{audio:a}}},"response.text.delta":e=>{const{item_id:t,content_index:n,delta:s}=e,i=this.itemLookup[t];if(!i)throw new Error(`response.text.delta: Item "${t}" not found`);return i.content[n].text+=s,i.formatted.text+=s,{item:i,delta:{text:s}}},"response.function_call_arguments.delta":e=>{const{item_id:t,delta:n}=e,s=this.itemLookup[t];if(!s)throw new Error(`response.function_call_arguments.delta: Item "${t}" not found`);return s.arguments+=n,s.formatted.tool.arguments+=n,{item:s,delta:{arguments:n}}}};constructor(){this.clear()}clear(){return this.itemLookup={},this.items=[],this.responseLookup={},this.responses=[],this.queuedSpeechItems={},this.queuedTranscriptItems={},this.queuedInputAudio=null,!0}queueInputAudio(e){return this.queuedInputAudio=e,e}processEvent(e,...t){if(!e.event_id)throw console.error(e),new Error('Missing "event_id" on event');if(!e.type)throw console.error(e),new Error('Missing "type" on event');const n=this.EventProcessors[e.type];if(!n)throw new Error(`Missing conversation event processor for "${e.type}"`);return n.call(this,e,...t)}getItem(e){return this.itemLookup[e]||null}getItems(){return this.items.slice()}}class l extends a{constructor({url:e,apiKey:t,dangerouslyAllowAPIKeyInBrowser:n,debug:s}={}){super(),this.defaultSessionConfig={modalities:["text","audio"],instructions:"",voice:"verse",input_audio_format:"pcm16",output_audio_format:"pcm16",input_audio_transcription:null,turn_detection:null,tools:[],tool_choice:"auto",temperature:.8,max_response_output_tokens:4096},this.sessionConfig={},this.transcriptionModels=[{model:"whisper-1"}],this.defaultServerVadConfig={type:"server_vad",threshold:.5,prefix_padding_ms:300,silence_duration_ms:200},this.realtime=new d({url:e,apiKey:t,dangerouslyAllowAPIKeyInBrowser:n,debug:s}),this.conversation=new u,this._resetConfig(),this._addAPIEventHandlers()}_resetConfig(){return this.sessionCreated=!1,this.tools={},this.sessionConfig=JSON.parse(JSON.stringify(this.defaultSessionConfig)),this.inputAudioBuffer=new Int16Array(0),!0}_addAPIEventHandlers(){this.realtime.on("client.*",(e=>{const t={time:(new Date).toISOString(),source:"client",event:e};this.dispatch("realtime.event",t)})),this.realtime.on("server.*",(e=>{const t={time:(new Date).toISOString(),source:"server",event:e};this.dispatch("realtime.event",t)})),this.realtime.on("server.session.created",(()=>this.sessionCreated=!0));const e=(e,...t)=>{const{item:n,delta:s}=this.conversation.processEvent(e,...t);return{item:n,delta:s}},t=(t,...n)=>{const{item:s,delta:i}=e(t,...n);return s&&this.dispatch("conversation.updated",{item:s,delta:i}),{item:s,delta:i}},n=async e=>{try{const t=JSON.parse(e.arguments),n=this.tools[e.name];if(!n)throw new Error(`Tool "${e.name}" has not been added`);const s=await n.handler(t);this.realtime.send("conversation.item.create",{item:{type:"function_call_output",call_id:e.call_id,output:JSON.stringify(s)}})}catch(t){this.realtime.send("conversation.item.create",{item:{type:"function_call_output",call_id:e.call_id,output:JSON.stringify({error:t.message})}})}this.createResponse()};return this.realtime.on("server.response.created",e),this.realtime.on("server.response.output_item.added",e),this.realtime.on("server.response.content_part.added",e),this.realtime.on("server.input_audio_buffer.speech_started",(t=>{e(t),this.dispatch("conversation.interrupted")})),this.realtime.on("server.input_audio_buffer.speech_stopped",(t=>e(t,this.inputAudioBuffer))),this.realtime.on("server.conversation.item.created",(e=>{const{item:n}=t(e);this.dispatch("conversation.item.appended",{item:n}),"completed"===n.status&&this.dispatch("conversation.item.completed",{item:n})})),this.realtime.on("server.conversation.item.truncated",t),this.realtime.on("server.conversation.item.deleted",t),this.realtime.on("server.conversation.item.input_audio_transcription.completed",t),this.realtime.on("server.response.audio_transcript.delta",t),this.realtime.on("server.response.audio.delta",t),this.realtime.on("server.response.text.delta",t),this.realtime.on("server.response.function_call_arguments.delta",t),this.realtime.on("server.response.output_item.done",(async e=>{const{item:s}=t(e);"completed"===s.status&&this.dispatch("conversation.item.completed",{item:s}),s.formatted.tool&&n(s.formatted.tool)})),!0}isConnected(){return this.realtime.isConnected()}reset(){return this.disconnect(),this.clearEventHandlers(),this.realtime.clearEventHandlers(),this._resetConfig(),this._addAPIEventHandlers(),!0}async connect(){if(this.isConnected())throw new Error("Already connected, use .disconnect() first");return await this.realtime.connect(),this.updateSession(),!0}async waitForSessionCreated(){if(!this.isConnected())throw new Error("Not connected, use .connect() first");for(;!this.sessionCreated;)await new Promise((e=>setTimeout((()=>e()),1)));return!0}disconnect(){this.sessionCreated=!1,this.realtime.isConnected()&&this.realtime.disconnect(),this.conversation.clear()}getTurnDetectionType(){return this.sessionConfig.turn_detection?.type||null}addTool(e,t){if(!e?.name)throw new Error("Missing tool name in definition");const n=e?.name;if(this.tools[n])throw new Error(`Tool "${n}" already added. Please use .removeTool("${n}") before trying to add again.`);if("function"!=typeof t)throw new Error(`Tool "${n}" handler must be a function`);return this.tools[n]={definition:e,handler:t},this.updateSession(),this.tools[n]}removeTool(e){if(!this.tools[e])throw new Error(`Tool "${e}" does not exist, can not be removed.`);return delete this.tools[e],!0}deleteItem(e){return this.realtime.send("conversation.item.delete",{item_id:e}),!0}updateSession({modalities:e,instructions:t,voice:n,input_audio_format:s,output_audio_format:i,input_audio_transcription:o,turn_detection:r,tools:a,tool_choice:d,temperature:u,max_response_output_tokens:l}={}){void 0!==e&&(this.sessionConfig.modalities=e),void 0!==t&&(this.sessionConfig.instructions=t),void 0!==n&&(this.sessionConfig.voice=n),void 0!==s&&(this.sessionConfig.input_audio_format=s),void 0!==i&&(this.sessionConfig.output_audio_format=i),void 0!==o&&(this.sessionConfig.input_audio_transcription=o),void 0!==r&&(this.sessionConfig.turn_detection=r),void 0!==a&&(this.sessionConfig.tools=a),void 0!==d&&(this.sessionConfig.tool_choice=d),void 0!==u&&(this.sessionConfig.temperature=u),void 0!==l&&(this.sessionConfig.max_response_output_tokens=l);const c=[].concat((a||[]).map((e=>{const t={type:"function",...e};if(this.tools[t?.name])throw new Error(`Tool "${t?.name}" has already been defined`);return t})),Object.keys(this.tools).map((e=>({type:"function",...this.tools[e].definition})))),h={...this.sessionConfig};return h.tools=c,this.realtime.isConnected()&&this.realtime.send("session.update",{session:h}),!0}sendUserMessageContent(e=[]){if(e.length){for(const t of e)"input_audio"===t.type&&(t.audio instanceof ArrayBuffer||t.audio instanceof Int16Array)&&(t.audio=o.arrayBufferToBase64(t.audio));this.realtime.send("conversation.item.create",{item:{type:"message",role:"user",content:e}})}return this.createResponse(),!0}appendInputAudio(e){return e.byteLength>0&&(this.realtime.send("input_audio_buffer.append",{audio:o.arrayBufferToBase64(e)}),this.inputAudioBuffer=o.mergeInt16Arrays(this.inputAudioBuffer,e)),!0}createResponse(){return null===this.getTurnDetectionType()&&this.inputAudioBuffer.byteLength>0&&(this.realtime.send("input_audio_buffer.commit"),this.conversation.queueInputAudio(this.inputAudioBuffer),this.inputAudioBuffer=new Int16Array(0)),this.realtime.send("response.create"),!0}cancelResponse(e,t=0){if(!e)return this.realtime.send("response.cancel"),{item:null};if(e){const n=this.conversation.getItem(e);if(!n)throw new Error(`Could not find item "${e}"`);if("message"!==n.type)throw new Error('Can only cancelResponse messages with type "message"');if("assistant"!==n.role)throw new Error('Can only cancelResponse messages with role "assistant"');this.realtime.send("response.cancel");const s=n.content.findIndex((e=>"audio"===e.type));if(-1===s)throw new Error("Could not find audio on item to cancel");return this.realtime.send("conversation.item.truncate",{item_id:e,content_index:s,audio_end_ms:Math.floor(t/this.conversation.defaultFrequency*1e3)}),{item:n}}}async waitForNextItem(){const e=await this.waitForNext("conversation.item.appended"),{item:t}=e;return{item:t}}async waitForNextCompletedItem(){const e=await this.waitForNext("conversation.item.completed"),{item:t}=e;return{item:t}}}}},t={};function n(s){var i=t[s];if(void 0!==i)return i.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,n),o.exports}n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};const{RealtimeClient:s}=n(605);window.RealtimeClient=s})();